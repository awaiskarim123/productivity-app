// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               String    @id @default(cuid())
  email            String    @unique
  passwordHash     String
  name             String?
  dailyGoalMinutes Int       @default(300)
  focusStreak      Int       @default(0)
  lastLoginAt      DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  workSessions   WorkSession[]
  focusSessions  FocusSession[]
  refreshTokens  RefreshToken[]
  tasks          Task[]
  habits         Habit[]
  notes          Note[]
  weeklyInsights WeeklyInsight[]
  goals          Goal[]
}

model WorkSession {
  id              String    @id @default(cuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  startedAt       DateTime  @default(now())
  endedAt         DateTime?
  durationMinutes Int?
  notes           String?
  createdAt       DateTime  @default(now())
  deletedAt       DateTime?

  @@index([userId, startedAt])
  @@index([userId, deletedAt])
}

model FocusSession {
  id              String           @id @default(cuid())
  userId          String
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  mode            FocusSessionMode @default(FOCUS)
  startedAt       DateTime         @default(now())
  endedAt         DateTime?
  targetMinutes   Int
  durationMinutes Int?
  completed       Boolean          @default(false)
  distractions    Int              @default(0)
  notes           String?
  createdAt       DateTime         @default(now())
  deletedAt       DateTime?
  goalId          String?
  goal            Goal?            @relation(fields: [goalId], references: [id], onDelete: SetNull)

  @@index([userId, startedAt])
  @@index([userId, deletedAt])
  @@index([goalId])
}

model RefreshToken {
  id        String    @id @default(cuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  tokenHash String    @unique
  expiresAt DateTime
  revokedAt DateTime?
  userAgent String?
  ipAddress String?
  createdAt DateTime  @default(now())

  @@index([userId])
  @@index([tokenHash])
}

model Quote {
  id        String   @id @default(cuid())
  text      String   @unique
  author    String?
  category  String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
}

enum FocusSessionMode {
  FOCUS
  BREAK
}

model Task {
  id          String       @id @default(cuid())
  userId      String
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  title       String
  description String?
  completed   Boolean      @default(false)
  priority    TaskPriority @default(MEDIUM)
  dueDate     DateTime?
  category    String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  completedAt DateTime?
  deletedAt   DateTime?
  goalId      String?
  goal        Goal?        @relation(fields: [goalId], references: [id], onDelete: SetNull)

  @@index([userId, completed])
  @@index([userId, dueDate])
  @@index([userId, deletedAt])
  @@index([goalId])
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model Habit {
  id          String     @id @default(cuid())
  userId      String
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  name        String
  description String?
  color       String     @default("#34d399")
  icon        String?
  targetDays  Int        @default(7)
  streak      Int        @default(0)
  bestStreak  Int        @default(0)
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  deletedAt   DateTime?
  logs        HabitLog[]
  goalId      String?
  goal        Goal?      @relation(fields: [goalId], references: [id], onDelete: SetNull)

  @@index([userId, isActive])
  @@index([userId, deletedAt])
  @@index([goalId])
}

model HabitLog {
  id        String   @id @default(cuid())
  habitId   String
  habit     Habit    @relation(fields: [habitId], references: [id], onDelete: Cascade)
  date      DateTime @default(now())
  notes     String?
  createdAt DateTime @default(now())

  @@unique([habitId, date])
  @@index([habitId, date])
}

model Note {
  id        String    @id @default(cuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  title     String
  content   String
  tags      String[]
  isPinned  Boolean   @default(false)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([userId, createdAt])
  @@index([userId, isPinned])
  @@index([userId, deletedAt])
}

model WeeklyInsight {
  id                     String   @id @default(cuid())
  userId                 String
  user                   User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  weekStart              DateTime
  weekEnd                DateTime
  peakHours              Int[] // Array of hours (0-23) where productivity is highest
  lowProductivityDays    String[] // Array of day names (e.g., ["Monday", "Friday"])
  weekOverWeekTrend      String // "improving", "declining", "stable"
  averageDailyMinutes    Int
  totalSessions          Int
  completedFocusSessions Int
  habitCorrelations      Json? // Store habit impact data as JSON
  insights               Json // Store all insights as JSON
  recommendations        Json // Store recommendations as JSON
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  @@unique([userId, weekStart])
}

enum GoalType {
  QUARTERLY
  MONTHLY
}

enum GoalHealthStatus {
  ON_TRACK
  AT_RISK
  OFF_TRACK
}

model Goal {
  id              String           @id @default(cuid())
  userId          String
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  title           String
  description     String?
  type            GoalType
  startDate       DateTime
  endDate         DateTime
  targetValue     Float            @default(100)
  currentValue    Float            @default(0)
  progressPercent Float            @default(0)
  healthStatus    GoalHealthStatus @default(ON_TRACK)
  isActive        Boolean          @default(true)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  deletedAt       DateTime?

  // Relations
  keyResults      KeyResult[]
  tasks           Task[]
  habits          Habit[]
  focusSessions   FocusSession[]

  @@index([userId, isActive])
  @@index([userId, startDate])
  @@index([userId, endDate])
  @@index([userId, deletedAt])
}

model KeyResult {
  id              String           @id @default(cuid())
  goalId          String
  goal            Goal             @relation(fields: [goalId], references: [id], onDelete: Cascade)
  title           String
  description     String?
  targetValue     Float
  currentValue    Float            @default(0)
  progressPercent Float            @default(0)
  weight          Float            @default(1.0) // Weight for calculating goal progress
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@index([goalId])
}
